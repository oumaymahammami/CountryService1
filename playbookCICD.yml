---
- name: Build and Deploy to Docker Desktop Kubernetes
  hosts: localhost
  connection: local
  
  vars_files:
    - vault.yml
  
  vars:
    image_name: country-service
    image_tag: "v1"
    dockerfile_path: '.'
    monitoring_namespace: monitoring
    app_namespace: jenkins

  tasks:
    - name: Verify Kubernetes access
      kubernetes.core.k8s_info:
        kind: Node
      register: k8s_check

    - name: Display Kubernetes info
      debug:
        msg: |
          âœ… Kubernetes accessible!
          Cluster: {{ k8s_check.resources[0].metadata.name }}
          Version: {{ k8s_check.resources[0].status.nodeInfo.kubeletVersion }}

    - name: Create monitoring namespace
      kubernetes.core.k8s:
        api_version: v1
        kind: Namespace
        name: "{{ monitoring_namespace }}"
        state: present

    - name: Log in to Docker Hub
      community.docker.docker_login:
        username: "{{ docker_registry_username }}"
        password: "{{ docker_registry_password }}"
        reauthorize: yes
    
    - name: Build Docker image
      community.docker.docker_image:
        build:
          path: "{{ dockerfile_path }}"
        name: "{{ docker_registry_username }}/{{ image_name }}:{{ image_tag }}"
        source: build
        state: present
    
    - name: Push the Docker image to Docker Hub
      community.docker.docker_image:
        name: "{{ docker_registry_username }}/{{ image_name }}:{{ image_tag }}"
        push: yes
        source: local
    
    - name: Deploy application to Kubernetes
      kubernetes.core.k8s:
        state: present
        namespace: "{{ app_namespace }}"
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: country-service
            namespace: "{{ app_namespace }}"
            labels:
              app: country-service
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: country-service
            template:
              metadata:
                labels:
                  app: country-service
                annotations:
                  prometheus.io/scrape: "true"
                  prometheus.io/path: "/actuator/prometheus"
                  prometheus.io/port: "8080"
              spec:
                containers:
                - name: country-service
                  image: "{{ docker_registry_username }}/{{ image_name }}:{{ image_tag }}"
                  ports:
                  - containerPort: 8080
                  env:
                  - name: SPRING_PROFILES_ACTIVE
                    value: "prod"
                  - name: MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE
                    value: "health,info,metrics,prometheus"
                  - name: MANAGEMENT_ENDPOINT_PROMETHEUS_ENABLED
                    value: "true"
                  - name: MANAGEMENT_METRICS_EXPORT_PROMETHEUS_ENABLED
                    value: "true"
                  resources:
                    requests:
                      memory: "256Mi"
                      cpu: "250m"
                    limits:
                      memory: "512Mi"
                      cpu: "500m"
                  livenessProbe:
                    httpGet:
                      path: /actuator/health
                      port: 8080
                    initialDelaySeconds: 30
                    periodSeconds: 10
                  readinessProbe:
                    httpGet:
                      path: /actuator/health
                      port: 8080
                    initialDelaySeconds: 20
                    periodSeconds: 5

    - name: Expose application with Service
      kubernetes.core.k8s:
        state: present
        namespace: "{{ app_namespace }}"
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: country-service
            namespace: "{{ app_namespace }}"
          spec:
            type: NodePort
            selector:
              app: country-service
            ports:
            - port: 8080
              targetPort: 8080
              nodePort: 30008

    - name: Deploy Prometheus
      kubernetes.core.k8s:
        state: present
        namespace: "{{ monitoring_namespace }}"
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: prometheus
            namespace: "{{ monitoring_namespace }}"
            labels:
              app: prometheus
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: prometheus
            template:
              metadata:
                labels:
                  app: prometheus
              spec:
                containers:
                - name: prometheus
                  image: prom/prometheus:latest
                  ports:
                  - containerPort: 9090
                  args:
                  - '--config.file=/etc/prometheus/prometheus.yml'
                  - '--web.enable-lifecycle'
                  - '--storage.tsdb.retention.time=200h'

    - name: Expose Prometheus with Service
      kubernetes.core.k8s:
        state: present
        namespace: "{{ monitoring_namespace }}"
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: prometheus-service
            namespace: "{{ monitoring_namespace }}"
          spec:
            type: NodePort
            ports:
            - port: 9090
              targetPort: 9090
              nodePort: 30009
            selector:
              app: prometheus

    - name: Deploy Grafana
      kubernetes.core.k8s:
        state: present
        namespace: "{{ monitoring_namespace }}"
        definition:
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: grafana
            namespace: "{{ monitoring_namespace }}"
            labels:
              app: grafana
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: grafana
            template:
              metadata:
                labels:
                  app: grafana
              spec:
                containers:
                - name: grafana
                  image: grafana/grafana:latest
                  ports:
                  - containerPort: 3000
                  env:
                  - name: GF_SECURITY_ADMIN_PASSWORD
                    value: "admin"

    - name: Expose Grafana with Service
      kubernetes.core.k8s:
        state: present
        namespace: "{{ monitoring_namespace }}"
        definition:
          apiVersion: v1
          kind: Service
          metadata:
            name: grafana-service
            namespace: "{{ monitoring_namespace }}"
          spec:
            type: NodePort
            ports:
            - port: 3000
              targetPort: 3000
              nodePort: 30010
            selector:
              app: grafana

    - name: Wait for application to be ready
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ app_namespace }}"
        label_selectors:
          - app = country-service
      register: app_pods
      until: app_pods.resources | length > 0 and app_pods.resources[0].status.phase == "Running"
      retries: 12
      delay: 10

    - name: Wait for monitoring stack to be ready
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: "{{ monitoring_namespace }}"
        label_selectors:
          - app in [prometheus, grafana]
      register: monitoring_pods
      until: monitoring_pods.resources | length >= 2
      retries: 15
      delay: 10

    - name: Display deployment information
      debug:
        msg: |
          ğŸ‰ DÃ‰PLOIEMENT RÃ‰USSI SUR DOCKER DESKTOP KUBERNETES!
          
          ğŸ“± VOTRE APPLICATION:
          â†’ URL: http://localhost:30008/getcountries
          â†’ SantÃ©: http://localhost:30008/actuator/health
          â†’ MÃ©triques: http://localhost:30008/actuator/prometheus
          
          ğŸ“Š VOTRE SURVEILLANCE:
          â†’ Prometheus: http://localhost:30009
          â†’ Grafana: http://localhost:30010 (admin/admin)
          
          ğŸ” VÃ‰RIFICATION:
          kubectl get pods -n {{ app_namespace }}
          kubectl get pods -n {{ monitoring_namespace }}
          kubectl get svc -A | grep -E "(30008|30009|30010)"
