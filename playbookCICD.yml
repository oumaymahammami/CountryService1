---
- name: Build and Deploy to Docker Desktop Kubernetes
  hosts: localhost
  connection: local
  
  vars_files:
    - vault.yml
  
  vars:
    image_name: country-service
    image_tag: "v1"
    dockerfile_path: '.'
    monitoring_namespace: monitoring
    app_namespace: jenkins

  tasks:
    - name: Verify Kubernetes access
      command: kubectl cluster-info
      register: k8s_check
      changed_when: false

    - name: Display Kubernetes status
      debug:
        msg: "âœ… Kubernetes accessible: {{ k8s_check.stdout }}"

    - name: Create monitoring namespace
      command: kubectl create namespace {{ monitoring_namespace }} --dry-run=client -o yaml | kubectl apply -f -
      register: create_monitoring_ns
      changed_when: create_monitoring_ns.stdout != ""

    - name: Log in to Docker Hub
      community.docker.docker_login:
        username: "{{ docker_registry_username }}"
        password: "{{ docker_registry_password }}"
        reauthorize: yes
    
    - name: Build Docker image
      community.docker.docker_image:
        build:
          path: "{{ dockerfile_path }}"
        name: "{{ docker_registry_username }}/{{ image_name }}:{{ image_tag }}"
        source: build
        state: present
    
    - name: Push the Docker image to Docker Hub
      community.docker.docker_image:
        name: "{{ docker_registry_username }}/{{ image_name }}:{{ image_tag }}"
        push: yes
        source: local
    
    - name: Deploy application using kubectl
      command: |
        kubectl apply -f - <<EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: country-service
          namespace: {{ app_namespace }}
          labels:
            app: country-service
        spec:
          replicas: 2
          selector:
            matchLabels:
              app: country-service
          template:
            metadata:
              labels:
                app: country-service
              annotations:
                prometheus.io/scrape: "true"
                prometheus.io/path: "/actuator/prometheus"
                prometheus.io/port: "8080"
            spec:
              containers:
              - name: country-service
                image: {{ docker_registry_username }}/{{ image_name }}:{{ image_tag }}
                ports:
                - containerPort: 8080
                env:
                - name: SPRING_PROFILES_ACTIVE
                  value: "prod"
                - name: MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE
                  value: "health,info,metrics,prometheus"
                - name: MANAGEMENT_ENDPOINT_PROMETHEUS_ENABLED
                  value: "true"
                resources:
                  requests:
                    memory: "256Mi"
                    cpu: "250m"
                  limits:
                    memory: "512Mi"
                    cpu: "500m"
                livenessProbe:
                  httpGet:
                    path: /actuator/health
                    port: 8080
                  initialDelaySeconds: 30
                  periodSeconds: 10
                readinessProbe:
                  httpGet:
                    path: /actuator/health
                    port: 8080
                  initialDelaySeconds: 20
                  periodSeconds: 5
        EOF
      register: deploy_app

    - name: Expose application with Service
      command: |
        kubectl apply -f - <<EOF
        apiVersion: v1
        kind: Service
        metadata:
          name: country-service
          namespace: {{ app_namespace }}
        spec:
          type: NodePort
          selector:
            app: country-service
          ports:
          - port: 8080
            targetPort: 8080
            nodePort: 30008
        EOF
      register: expose_app

    - name: Deploy Prometheus
      command: |
        kubectl apply -f - <<EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: prometheus
          namespace: {{ monitoring_namespace }}
          labels:
            app: prometheus
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: prometheus
          template:
            metadata:
              labels:
                app: prometheus
            spec:
              containers:
              - name: prometheus
                image: prom/prometheus:latest
                ports:
                - containerPort: 9090
        EOF
      register: deploy_prometheus

    - name: Expose Prometheus
      command: |
        kubectl apply -f - <<EOF
        apiVersion: v1
        kind: Service
        metadata:
          name: prometheus-service
          namespace: {{ monitoring_namespace }}
        spec:
          type: NodePort
          ports:
          - port: 9090
            targetPort: 9090
            nodePort: 30009
          selector:
            app: prometheus
        EOF
      register: expose_prometheus

    - name: Deploy Grafana
      command: |
        kubectl apply -f - <<EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: grafana
          namespace: {{ monitoring_namespace }}
          labels:
            app: grafana
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: grafana
          template:
            metadata:
              labels:
                app: grafana
            spec:
              containers:
              - name: grafana
                image: grafana/grafana:latest
                ports:
                - containerPort: 3000
                env:
                - name: GF_SECURITY_ADMIN_PASSWORD
                  value: "admin"
        EOF
      register: deploy_grafana

    - name: Expose Grafana
      command: |
        kubectl apply -f - <<EOF
        apiVersion: v1
        kind: Service
        metadata:
          name: grafana-service
          namespace: {{ monitoring_namespace }}
        spec:
          type: NodePort
          ports:
          - port: 3000
            targetPort: 3000
            nodePort: 30010
          selector:
            app: grafana
        EOF
      register: expose_grafana

    - name: Wait for application pods
      command: kubectl wait --for=condition=ready pod -l app=country-service -n {{ app_namespace }} --timeout=120s
      register: wait_app
      retries: 3
      delay: 10
      until: wait_app.rc == 0

    - name: Wait for monitoring pods
      command: kubectl wait --for=condition=ready pod -l app=prometheus -n {{ monitoring_namespace }} --timeout=120s
      register: wait_prometheus
      retries: 3
      delay: 10

    - name: Display deployment information
      debug:
        msg: |
          ðŸŽ‰ DÃ‰PLOIEMENT KUBERNETES RÃ‰USSI !
          
          ðŸ“± VOTRE APPLICATION:
          â†’ URL: http://localhost:30008/getcountries
          â†’ SantÃ©: http://localhost:30008/actuator/health
          
          ðŸ“Š VOTRE SURVEILLANCE:
          â†’ Prometheus: http://localhost:30009
          â†’ Grafana: http://localhost:30010 (admin/admin)
          
          ðŸ” VÃ‰RIFICATION:
          kubectl get pods -n {{ app_namespace }}
          kubectl get pods -n {{ monitoring_namespace }}
          kubectl get svc -A | grep 3000
